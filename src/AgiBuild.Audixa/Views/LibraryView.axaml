<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:AgiBuild.Audixa.ViewModels"
             xmlns:domain="using:AgiBuild.Audixa.Domain"
             xmlns:primitives="using:Avalonia.Controls.Primitives"
             xmlns:conv="using:AgiBuild.Audixa.Converters"
             mc:Ignorable="d"
             x:Class="AgiBuild.Audixa.Views.LibraryView"
             x:DataType="vm:LibraryViewModel">
  <UserControl.Resources>
    <conv:IsDirectoryToIconConverter x:Key="IsDirToIconConverter" />
    <conv:InverseBooleanConverter x:Key="InverseBool" />
    <conv:IsNotNullConverter x:Key="IsNotNullConverter" />
  </UserControl.Resources>
  <ScrollViewer x:Name="RootScroll" ScrollChanged="RootScroll_OnScrollChanged">
    <Border Padding="24">
      <StackPanel Spacing="18">
        <TextBlock Text="Add Source" FontSize="20" FontWeight="SemiBold" />

        <!-- Prototype-aligned source cards (placeholder) -->
        <primitives:UniformGrid Columns="4" Rows="1" HorizontalAlignment="Stretch">
          <Border Background="#1a1625" CornerRadius="12" Padding="16" Margin="0,0,12,0">
            <StackPanel HorizontalAlignment="Center" Spacing="6">
              <TextBlock Text="ðŸ“‚" FontSize="28" HorizontalAlignment="Center" />
              <TextBlock Text="Local Storage" HorizontalAlignment="Center"/>
              <TextBlock Text="Device Files" Opacity="0.7" FontSize="12" HorizontalAlignment="Center"/>
            </StackPanel>
          </Border>
          <Border Background="#1a1625" CornerRadius="12" Padding="16" Margin="0,0,12,0">
            <StackPanel HorizontalAlignment="Center" Spacing="6">
              <TextBlock Text="ðŸ–¥ï¸" FontSize="28" HorizontalAlignment="Center" />
              <TextBlock Text="SMB / NAS" HorizontalAlignment="Center"/>
              <TextBlock Text="Home Server" Opacity="0.7" FontSize="12" HorizontalAlignment="Center"/>
            </StackPanel>
          </Border>
          <Border Background="#1a1625" CornerRadius="12" Padding="16" Margin="0,0,12,0" Opacity="0.35">
            <StackPanel HorizontalAlignment="Center" Spacing="6">
              <TextBlock Text="â˜ï¸" FontSize="28" HorizontalAlignment="Center" />
              <TextBlock Text="WebDAV" HorizontalAlignment="Center"/>
              <TextBlock Text="(v1+)" Opacity="0.7" FontSize="12" HorizontalAlignment="Center"/>
            </StackPanel>
          </Border>
          <Border Background="#1a1625" CornerRadius="12" Padding="16" Opacity="0.35">
            <StackPanel HorizontalAlignment="Center" Spacing="6">
              <TextBlock Text="ðŸŒ" FontSize="28" HorizontalAlignment="Center" />
              <TextBlock Text="Subtitle Search" HorizontalAlignment="Center"/>
              <TextBlock Text="(v1+)" Opacity="0.7" FontSize="12" HorizontalAlignment="Center"/>
            </StackPanel>
          </Border>
        </primitives:UniformGrid>

        <Button Content="Open Local MP4"
                Command="{Binding OpenLocalMp4Command}"
                HorizontalAlignment="Left"
                Padding="12,8" />

        <TextBlock Text="SMB / NAS (SMB2/SMB3)" FontSize="16" FontWeight="SemiBold" Margin="0,10,0,0"/>
        <StackPanel Orientation="Horizontal" Spacing="10">
          <ComboBox Width="360"
                    ItemsSource="{Binding SmbProfileList}"
                    SelectedItem="{Binding SelectedSmbProfile}">
            <ComboBox.ItemTemplate>
              <DataTemplate>
                <TextBlock Text="{Binding Name}" />
              </DataTemplate>
            </ComboBox.ItemTemplate>
          </ComboBox>
          <Button Content="Refresh" Command="{Binding RefreshSmbProfilesCommand}" Padding="10,6"/>
        </StackPanel>

        <StackPanel Orientation="Horizontal" Spacing="10">
          <TextBox Width="360" Text="{Binding NewSmbRootPath}" Watermark="\\\\server\\share æˆ– smb://server/share" />
          <TextBox Width="200" Text="{Binding NewSmbUsername}" Watermark="username (optional)" />
          <TextBox Width="160" Text="{Binding NewSmbDomain}" Watermark="domain (optional)" />
        </StackPanel>

        <StackPanel Orientation="Horizontal" Spacing="10">
          <TextBox Width="260" Text="{Binding NewSmbPassword}" Watermark="password (optional)" PasswordChar="*"/>
          <CheckBox Content="Remember password" IsChecked="{Binding RememberSmbPassword}" VerticalAlignment="Center"/>
          <Button Content="Save New" Command="{Binding SaveSmbProfileCommand}" Padding="10,6" IsEnabled="{Binding IsSmbLoading, Converter={StaticResource InverseBool}}"/>
          <Button Content="Update" Command="{Binding UpdateSelectedSmbProfileCommand}" Padding="10,6" IsEnabled="{Binding IsSmbLoading, Converter={StaticResource InverseBool}}"/>
          <Button Content="Delete" Command="{Binding DeleteSelectedSmbProfileCommand}" Padding="10,6" IsEnabled="{Binding IsSmbLoading, Converter={StaticResource InverseBool}}"/>
          <Button Content="Browse" Command="{Binding BrowseSmbCommand}" Padding="10,6" IsEnabled="{Binding IsSmbLoading, Converter={StaticResource InverseBool}}"/>
        </StackPanel>

        <DockPanel>
          <Button DockPanel.Dock="Right"
                  Content="â†»"
                  Command="{Binding RefreshSmbListingCommand}"
                  Padding="8,2"
                  Margin="10,0,0,0"
                  IsEnabled="{Binding IsSmbLoading, Converter={StaticResource InverseBool}}"/>
          <TextBlock Text="{Binding CurrentSmbPath}" Opacity="0.7" FontSize="12"/>
        </DockPanel>
        <TextBlock Text="{Binding SmbLoadedCount, StringFormat={}{0} items loaded}" Opacity="0.6" FontSize="11"/>
        <ProgressBar IsVisible="{Binding IsSmbLoading}" IsIndeterminate="True" Height="3" />

        <Border Background="#140f1e" CornerRadius="12" Padding="8">
          <ListBox ItemsSource="{Binding SmbEntries}"
                   Background="Transparent"
                   BorderThickness="0"
                   IsEnabled="{Binding IsSmbLoading, Converter={StaticResource InverseBool}}">
            <ListBox.ItemTemplate>
              <DataTemplate x:DataType="vm:LibraryViewModel+SmbEntryViewModel">
                <Button Command="{Binding OpenCommand}" CommandParameter="{Binding .}" Background="Transparent" BorderThickness="0" Padding="8">
                  <DockPanel>
                    <TextBlock DockPanel.Dock="Left" Text="{Binding IsDirectory, Converter={StaticResource IsDirToIconConverter}}" Margin="0,0,10,0"/>
                    <TextBlock Text="{Binding Name}" />
                  </DockPanel>
                </Button>
              </DataTemplate>
            </ListBox.ItemTemplate>
          </ListBox>
        </Border>

        <Button Content="Load more"
                Command="{Binding LoadMoreSmbCommand}"
                IsVisible="{Binding CanLoadMoreSmbEntries}"
                IsEnabled="{Binding IsSmbLoading, Converter={StaticResource InverseBool}}"
                HorizontalAlignment="Left"
                Padding="10,6"/>

        <!-- Auto-load / error feedback for infinite scroll -->
        <TextBlock Text="Loading moreâ€¦"
                   IsVisible="{Binding IsSmbLoadingMore}"
                   Opacity="0.7"
                   FontSize="11"
                   Margin="0,6,0,0"/>

        <Border Background="#1a1625"
                CornerRadius="8"
                Padding="10"
                Margin="0,8,0,0"
                IsVisible="{Binding SmbLoadMoreError, Converter={StaticResource IsNotNullConverter}}">
          <DockPanel>
            <StackPanel>
              <TextBlock Text="Load more failed" FontWeight="SemiBold" />
              <TextBlock Text="{Binding SmbLoadMoreError}" Opacity="0.7" FontSize="11" TextWrapping="Wrap"/>
            </StackPanel>
            <Button DockPanel.Dock="Right"
                    Content="Retry"
                    Command="{Binding LoadMoreSmbCommand}"
                    Margin="10,0,0,0"
                    Padding="10,6"/>
          </DockPanel>
        </Border>

        <TextBlock Text="Continue Learning" FontSize="20" FontWeight="SemiBold" Margin="0,10,0,0"/>

        <StackPanel Orientation="Horizontal" Spacing="10">
          <TextBlock Text="Recent" FontSize="16" FontWeight="SemiBold"/>
          <Button Content="Refresh" Command="{Binding RefreshRecentsCommand}" Padding="10,6"/>
        </StackPanel>

        <Border Background="#140f1e" CornerRadius="12" Padding="14">
          <ListBox ItemsSource="{Binding RecentItems}" Background="Transparent" BorderThickness="0">
            <ListBox.ItemTemplate>
              <DataTemplate x:DataType="domain:MediaItem">
                <Button Command="{Binding $parent[vm:LibraryViewModel].OpenRecentCommand}"
                        CommandParameter="{Binding .}"
                        Background="Transparent"
                        BorderThickness="0"
                        Padding="8">
                  <StackPanel>
                    <TextBlock Text="{Binding DisplayName}" FontWeight="SemiBold"/>
                    <TextBlock Text="{Binding SourceLocator}" Opacity="0.6" FontSize="11" TextTrimming="CharacterEllipsis"/>
                  </StackPanel>
                </Button>
              </DataTemplate>
            </ListBox.ItemTemplate>
          </ListBox>
        </Border>
      </StackPanel>
    </Border>
  </ScrollViewer>
</UserControl>
